<html lang="en">

{include file="./backend/header.html"}

<body>
{include file="./backend/sidebar.html"}
{include file="./backend/top.html"}
<!-- Start Content-->
<div class="container-fluid">

    <!-- 弹窗新增文章 -->
    <div id="myModal1" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         style="display: none;" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">新增文章</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">

                    <form action="{:url('add_article')}" method="post">
                        <input type="text" name="apic" hidden id="cover" value="">
                        <div class="page-wrap">

                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">文章标题：</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="atitle" value="">
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">封面图：</label>
                                <div class="col-sm-10">
                                    <input class="btn btn-secondary selectImage file" id="selectImage"
                                           type="file"/>
                                    <img style="width: 100px;" class="cover" src=""/>
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">文章分类：</label>
                                <div class="col-sm-10">

                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="form-group mb-3">
                                                <select data-plugin="customselect" style="display: none;"
                                                        name="fenlei">
                                                    {foreach $fenlei as $item}
                                                    <option value="{$item->fname}">{$item->fname}</option>
                                                    {/foreach}
                                                </select>
                                                <div class="nice-select" tabindex="0"><span
                                                        class="current">{$item->fname}</span>
                                                    <ul class="list">
                                                        {foreach $fenlei as $item}
                                                        <li data-value="{$item->fname}" class="option selected">
                                                            {$item->fname}
                                                        </li>
                                                        {/foreach}
                                                    </ul>
                                                </div>

                                            </div>
                                        </div>

                                    </div>


                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">发布人：</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="aname" value="">
                                </div>
                            </div>


                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label">文章详情</label>
                                <div class="col-sm-10">
                                    <div id="agreement"></div>
                                    <textarea id="text1" hidden name="atext" value=""></textarea>
                                </div>
                            </div>
                            <div class="form-group mb-0 justify-content-end row">
                                <div class="col-9">
                                    <input type="submit" class="btn btn-outline-info" value="提交"/>
                                </div>
                            </div>


                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div><!-- 文章新增截止-->

    <!--查看文章详情-->
    <div id="myModal2" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         style="display: none;" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="width: 230%;float: left;left: -55%;">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabe2">文章详情</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body">

                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h2 class="header-title">文章介绍</h2>

                                    <div class="table-responsive mt-3">
                                        <table class="table mb-0">
                                            <thead class="thead-light">
                                            <tr>
                                                <th width="1%">ID</th>
                                                <th width="2%">文章标题</th>
                                                <th width="5%">文章详情</th>
                                            </tr>
                                            </thead>


                                            <tbody>
                                            {foreach $list as $item}
                                            <tr>

                                                <td>{$item->id}</td>
                                                <td>{$item->atitle}</td>
                                                <td>{$item->atext}</td>

                                            </tr>
                                            {/foreach}
                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

        </div>
    </div><!-- 查看文章详情截止-->

    <!-- 文章编辑-->

    <!-- 文章编辑截止-->
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <!-- <div class="page-title-right">
                <ol class="breadcrumb m-0"> -->
                <!-- <li class="breadcrumb-item"><a href="#">Pentacle</a></li> -->
                <!-- <li class="breadcrumb-item active">Dashboard</li> -->
                <!-- </ol>-->
            </div>
            <h4 class="page-title">Pentacle</h4>
        </div>

        <div class="container">
            <select class="test" id="my-menu">
                <option value="all">全部</option>
                {foreach $aname as $item}
                <option value={$item->aname}>{$item->aname}</option>
                {/foreach}
            </select>

            <!-- <button type="button" class="btn btn-outline-info" style="margin-top: -24px;"
            id="addNewArticle">新增</button> -->
            <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#myModal1"
                    style="margin-top: -24px;">新增
            </button>
            <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#myModal2"
                    style="margin-top: -24px;">查看详情
            </button>
            <!-- 下拉菜单js-->
            <script src="/static/js/jqueryTwo.js"></script>
            <script src="/static/js/jquery.fancyspinbox.js"></script>
            <script>
                $('#my-menu').fancyspinbox();
            </script>
            <!-- 必须保证在一个div中 并注意优先级-->
        </div>


        <form action="{:url('Articles/Search')}">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="请输入标题或发布人..." name="key">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="submit">
                        <i class="fe-search"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>

</div> <!-- container -->

<!--表格主体部位-->
<p>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body ribbon-box">


                <div class="ribbon ribbon-dark">文章介绍</div>
                <div class="table-responsive mt-3">
                    <table class="table mb-0">
                        <thead class="thead-light">
                        <tr>
                            <th width="1%">id</th>
                            <th width="3%">文章标题</th>
                            <th width="5%">封面图</th>
                            <th width="3%">发布人</th>
                            <th width="1%">点赞数</th>
                            <th width="1%">评论数</th>
                            <th width="3%">文章类别</th>
                            <th width="3%">推荐</th>
                            <th width="3%">创建时间</th>
                            <th width="3%">更改时间</th>
                            <th width="3%">操作</th>
                        </tr>
                        </thead>
                        <tbody>

                        {foreach $list as $item}
                        <tr class="cen" id="{$item->id}">  <!--按钮开关需要在此指定id-->
                            <td>{$item->id}</td>
                            <td>{$item->atitle}</td>
                            <td style="width: 130px;">
                                <img style="width: 80px;" src="{$item->apic}"/>
                            </td>
                            <td>{$item->aname}</td>
                            <td>{$item->likes}</td>
                            <td>{$item->allpinglun}</td>
                            <td>{$item->fenlei}</td>
                            <td>

                                <input class="state" type="checkbox" data-plugin="switchery"
                                       data-color="#039cfd" hidden {$item['state']==1? 'checked="checked"' : ''}>

                            </td>
                            <td>{$item->create_time}</td>
                            <td>{$item->update_time}</td>
                            <td>
                                <a title="编辑" class="edit" _id="{$item->id}" href="#">编辑</a>

                                <a title="删除" class="delete" _id="{$item->id}" href="#">删除</a>

                                <!--<button type="button" tabindex="0" class="btn btn-primary waves-effect waves-light"-->
                                <!--data-toggle="popover" data-trigger="focus" title=""-->
                                <!--data-content="{$item->atext}" data-original-title="查看详情">-->
                                <!--查看详情-->
                                <!--</button>-->
                            </td>
                        </tr>
                        {/foreach}

                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
</div>
<!--表格主体部位截止-->
<script>
    $(".selectImage").change(function (e) {
        //如果有选择图片则上传图片
        var files = e.target.files || e.dataTransfer.files;
        var formData = new FormData();
        if (files.length > 0) {
            formData.append('imgs[]', files[0]);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{:url("Index/uploads")}');
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    let resstr = xhr.responseText;
                    let resp = JSON.parse(resstr);
                    //console.log('上传成功:',resp.path);
                    //处理其他数据，这里根据需要进行调整
                    let imgepath = resp.path[0]; //组装数组
                    $("#cover").val(imgepath);//设置为组装后的图片数组
                    $(".cover").attr("src", imgepath);
                }
            };
            xhr.send(formData);
        }
    });
    //富文本
    var E = window.wangEditor;
    var editor = new E('#agreement');
    var $text1 = $('#text1');
    editor.customConfig.onchange = function (html) {
        // 监控变化，同步更新到 textarea
        $text1.val(html)
    };
    // 自定义菜单配置
    editor.customConfig.menus = [
        'undo',  // 撤销
        'redo',  // 重复
        'head',  // 标题
        'bold',  // 粗体
        'italic',  // 斜体
        'underline',  // 下划线
        'strikeThrough',  // 删除线
        'list',  // 列表
        'justify',  // 对齐方式
        'quote',  // 引用
        'image',  // 插入图片
        'table',  // 表格
        'code',  // 插入代码
    ];
    // 配置服务器端图片上传地址
    editor.customConfig.uploadImgServer = '{:url("index/upload")}';
    editor.customConfig.uploadFileName = 'imgs[]';
    editor.customConfig.debug = true;
    editor.create();

    // 初始化 textarea 的值
    $text1.val(editor.txt.html());
    //编辑
    $(".edit").click(function () {
        let id = this.getAttribute("_id");
        layer.open({
            type: 2,
            title: '编辑报名信息',
            shadeClose: true,
            shade: false,
            maxmin: true, //开启最大化最小化按钮
            area: ['750px', '750px'],
            content: '{:url("Articles/edit")}?id=' + id
        });
    });
//删除方法
    $('.delete').click(function () {
        let id = this.getAttribute("_id");
        layer.confirm('确认删除此内容？', {
            btn: ['确认', '取消'] //按钮
        }, function () {
            //删除ajax
            $.get("{:url('Articles/del_article')}?id=" + id,
                function (data, status) {
                    console.log(status, data);
                    if (data.code == 0)
                        layer.msg("删除成功", {icon: 1});
                    setTimeout(function () {
                        window.location.reload();
                    }, 1000);
                }
            );
        }, function () {

        });
    });
    //下拉菜单搜索方法
    $("#my-menu").change(function (e) {
        console.log(e.currentTarget.value);
        let selected = e.currentTarget.value;
        let action = "{$Request.action}";
        let path = "{:url('getByName')}?name=" + selected + "&action=" + action;
        window.location.href = (path);
    });
</script>
{include file="./backend/footer.html"}

</body>

</html>